# ラボ 2 - Azure Migrate を使用して Linux VM を Azure に移行する

## 目的

このラボでは、Azure Migrate – Server Migration ツールを使用して、オンプレミスから Linux VM ワークロードを移行します。必要な Azure リソースを準備し、移行前に VM をレプリケートします。

## 演習 1: ワークロードの移行

## タスク 1: Hyper-V VM の移行の準備

1. [**サーバー、データベース、Web アプリ**] ブレードで、ページを移動して [**移行ツール**] セクションに移動し、[**移行と最新化**] の下で [**検出**] を選択します。

![](./media/image1.png)

2. [**検出**] ブレードで、ドロップダウン [**移行先はどこですか?**] で [**Azure VM**] オプションを選択し、[**マシンは仮想化されていますか?**] メニューで [**はい、Hyper-V を使用**] を選択します。

3. [**ターゲット リージョン**] メニューで、[**米国西部 2**] を選択します。

![](./media/image2.png)

> <font color=red>**注** - ターゲット リージョンが、ラボ 1 で以前に記録した **AZMigrateRG** リソース グループの場所/リージョンと同じであることを確認します。</font>

4. チェックボックスをオンにし、[**リソースの作成**] を選択します。

5. 移行プロジェクトと Vault リソースの展開が完了するまで待ちます。

6. [**検出**] ブレードの [**Hyper-V ホスト サーバーの準備**] で、*その後の [**ダウンロード**] ボタンではなく、**ダウンロード** という単語を選択します。*

![](./media/image3.png)

> Hyper-V サーバーにレプリケーション プロバイダーをインストールするインストーラーがダウンロードされます。

7. [**検出**] ブレードの [**1. Hyper-V ホスト サーバーの準備**] で、[**ダウンロード**] ボタンを選択します。

![](./media/image4.png)

> プロジェクトに Hyper-V ホストを登録するために使用される登録キーがダウンロードされます。

8. [**ダウンロード**] フォルダーに移動し、[**AzureSiteRecoveryProvider**] ファイルを選択してインストーラーを起動します。

9. [Azure Site Recovery Provider セットアップ (Hyper-V サーバー)] ウィンドウの [**Microsoft Update**] タブで [**オン (推奨)**] を選択し、[**次へ**] を選択します。

10. [**インストール**] タブで、既定のインストール場所を受け入れ、[**インストール**] を選択します。

11. インストールが完了したら、[**登録**] を選択します。

> サーバーが既に登録されているというメッセージが表示された場合は、[**再登録**] を選択します。

12. Microsoft Azure Site Recovery ウィザードの [**Vault 設定**] タブで、[**キー ファイル**] ボックスの右側にある [**参照**] を選択します。

![](./media/image5.png)

13. [**ダウンロード**] フォルダーに移動し、[**az-migrate-project**] ファイルを選択して、[**開く**] を選択します。

![](./media/image6.png)

> キー ファイルが追加されると、[キー ファイル]、[サブスクリプション]、[Vault 名]、および [Hyper-V サイト名] の値が入力されます。

14. [**次へ**] を選択します。

15. [**プロキシ設定**] タブで、既定の設定を受け入れ、[**次へ**] を選択します。

> 登録が完了するまでに最大 5 分かかることがあります。

16. 登録が完了したら、[**完了**] を選択します。

17. ブラウザーに戻り、[**検出**] ブレードの [**2.登録を完了する** で、**登録を完了する** という単語を選択します。

![](./media/image25.png)

> 登録を完了するボタンを有効にするには、**ページを更新** して、このタスクの最初からオプションを再度選択する必要がある場合があります。

18. 登録が完了すると、次のメッセージが表示されます。

![自動的に生成された標識の説明のクローズアップ](./media/image7.jpeg)

> 仮想マシンの検出が完了するまでに最大 15 分かかる場合があり、メッセージを表示するにはページを更新する必要がある場合があります。完了していなくても、次のタスクに進みます。

## タスク 2: Azure リソースのセットアップ

Azure Migrate プロジェクトを作成したので、ターゲットの Azure 環境を実装する必要があります。

**仮想ネットワークを作成する**

1. Azure ポータルの **検索** ボックスに「```Virtual Networks```」と入力し、**仮想ネットワーク** を選択します。

2. **仮想ネットワーク** ブレードで、**作成** を選択します。

3. 次の設定を使用して仮想ネットワークを作成します。

- リソース グループ - ```AZMigrateRG```

- 仮想ネットワーク名 - ```migration-vnet-XXXXXX``` \[XXXXXX をランダムな数字に置き換えます\]

- リージョン **West US 2**

> <font color="red"> **注** - リージョンが、ラボ 1 で以前に記録した **AZMigrateRG** リソース グループの場所/リージョンと同じであることを確認します。</font>

**ストレージ アカウントを作成する**

1. Azure ポータルの [**検索**] ボックスに「ストレージ」と入力し、[**ストレージ アカウント**] を選択します。

2. [**ストレージ アカウント**] ブレードで、[**作成**] を選択します。

3. 次の設定を使用してストレージ アカウントを作成します。その他の設定はすべて既定値のままにします。

- リソース グループ - ```AZMigrateRG```

- ストレージ アカウント名 - ```saXXXXXX``` \[XXXXXX をランダムな数字に置き換えます\]

- リージョン - **West US 2**

> <font color="red"> **注** - リージョンが、ラボ 1 で以前に記録した **AZMigrateRG** リソース グループの場所/リージョンと同じであることを確認してください。</font>

- パフォーマンス - **標準**

- 冗長性 - **ローカル冗長ストレージ (LRS)**

4. [**ストレージ アカウントの作成**] ページの [**ネットワーク**] タブで、次の設定を行い、その他の設定はすべて既定値のままにします。

- ネットワーク アクセス - **選択した仮想ネットワークと IP アドレスからのパブリック アクセスを有効にする**

- 仮想ネットワーク - **migration-vnet-XXXXXX**

- サブネット - **デフォルト(10.0.0.0/24)**

![コンピューターのスクリーンショット 説明が自動的に生成されました](./media/image9.png)

5. [**データ保護**] タブで、[**BLOB の論理的な削除を有効にする**] のチェックを外します。その他の設定はすべて既定値のままにします。

6. [**確認**] を選択し、[**作成**] を選択します。

7. ストレージ アカウントが作成されたら、[**リソースに移動**] をクリックします。

8. [データ管理] を展開して [**データ保護**] を選択し、[**BLOB の論理的な削除を有効にする**] のチェックを外し、[**保存**] ボタンをクリックします。

> ![コンピューターのスクリーンショット 説明が自動的に生成されました](./media/image8.png)

**パブリック IP アドレスの作成**

1. Azure ポータルの [**検索**] ボックスに「```パブリック IP```」と入力し、[**パブリック IP アドレス**] を選択します。

2. **パブリック IP アドレス** ブレードで、**作成** を選択します。

3. 次の設定を使用してパブリック IP を作成します。

- リソース グループ - ```AZMigrateRG```

- リージョン - **West US 2**

> <font color="red"> **注** - リージョンが、ラボ 1 で以前に記録した **AZMigrateRG** リソース グループのロケーション/リージョンと **同じ** であることを確認します。</font>

- 名前 - ```ipXXXXXX``` \[XXXXXX をランダムな数字に置き換えます\]

- IP バージョン - **IPv4**

- SKU - **Basic**

- IP アドレスの割り当て - **静的**

- アイドル タイムアウト (分) - **4**

- DNS 名ラベル - ```rhel-web-XXXXXX``` \[XXXXXX をランダムな数字に置き換えます\]

4. [**確認 + 作成**] を選択し、[**作成**] を選択します

## タスク 3: Hyper-V VM のレプリケーションを構成する

1. Edge ブラウザーで新しいタブを開き、URL に移動します -
```https://portal.azure.com/?feature.customportal=false&feature.canmodifystamps=true&microsoft_azure_migrate=migratecanary#view/Microsoft_Azure_Migrate/AmhResourceMenuBlade/~/getStarted```

2. [**検出、評価、移行**] ボタンをクリックします。

![](./media/image10.png)

3. [**移行と最新化**] セクションで、

[**レプリケート**] を選択します。

![コンピューターのスクリーンショット 説明が自動的に生成されました](./media/image11.png)

4. [**Azure Migrate Servers、データベース、Web アプリ**] ページが表示されているブラウザー ページを更新する必要がある場合があります。

5. [**意図を指定**] ページの [**何を移行しますか?**] で [**サーバーまたは仮想マシン (VM)**] を選択し、[**移行先はどこですか?**] で [**Azure VM**] を選択します

6. [**マシンは仮想化されていますか?**] ドロップダウンで [**はい、Hyper-V を使用**] を選択し、[**続行**] ボタンをクリックします。

7.  [レプリケート] ページの [**仮想マシン**] タブで、次の設定を使用してレプリケーション条件を完了します。

- Azure Migrate 評価から移行設定をインポート - **はい、Azure Migrate 評価から移行設定を適用します**

- グループを選択 - **RHEL-Servers**

- 評価を選択 - **as-43240741**

- 仮想マシン **RHEL-DB-01** および **RHEL-WEB-01**

8. [レプリケート] ページの [**ターゲット設定**] タブで、次の設定を使用してターゲットの詳細を指定します。

- リソース グループ - **AZMigrateRG**

- キャッシュ ストレージ アカウント - **saXXXXXX**

- 仮想ネットワーク - **migration-vnet-XXXXXX**

- サブネット - **Default**

9. [レプリケート] ページの [**コンピューティング**] タブで、両方の VM で次の設定を使用します。

- Azure VM サイズ - **Standard_D2s_v3**

- OS タイプ - **Linux**

10. 残りのタブの設定はデフォルトのままにして、[**レプリケート**] を選択します。

11. [**Azure Migrate サーバー、データベース、Web アプリ**] ページに戻り、[**更新**] を選択してから、[**移行と最新化**] セクションで [**概要**] を選択します。

![](./media/image12.png)

12. [移行と最新化] ページの [**レプリケーション**] セクションで、レプリケートするマシンの一覧の [**ステータス**] 列を確認します。

![](./media/image13.png)

> ステータスが [**保護済み**] に変わるまで待ちます。これにはさらに 15 分かかる場合があります。

ステータス情報を更新するには、[**移行と最新化] の [レプリケートするマシン**] を更新する必要があります。

## タスク 4: テスト移行を実行する

1. Azure ポータルの [**移行と最新化 | レプリケーション**] ページで、**RHEL-DB-01** 仮想マシンを選択します。

![](./media/image14.png)

2. [**RHEL-DB-01**] ページで、[**テスト移行**] を選択します。

![](./media/image15.png)

3. **migration-vnet-XXXXXX** 仮想ネットワークを選択し、**テスト移行** を選択します。

4. **移行と最新化 マシンのレプリケーション** ページに戻り、**RHEL-WEB-01** 仮想マシンを選択します。

5. **RHEL-WEB-01** ページで、**migration-vnet-XXXXXX** 仮想ネットワークを使用して **テスト移行** を開始します。

6. **移行と最新化 マシンのレプリケーション** ページに戻ります。**レプリケーション ステータス** は **テスト フェイルオーバーを開始しています** になっているはずです。

![](./media/image16.png)

> **テスト フェイルオーバー** が完了するまで待ちます。これには約 5～7 分かかる場合があります。

7. [**移行と最新化のレプリケーション**] ページに戻り、[**更新**] を選択して、両方の仮想マシンが [**クリーンアップ テスト フェールオーバーが保留中**] 状態で一覧表示されていることを確認します。

**テスト移行を検証する**

8. Azure ポータルの [**検索**] ボックスに「仮想マシン」と入力し、[**仮想マシン**] を選択します。

9. 新しくレプリケートされた仮想マシンを表すエントリをメモします。

> 注 - 最初は、仮想マシンの名前は **asr-temp** プレフィックスとランダムに生成されたサフィックスで構成されますが、自動的に **RHEL-DB-01-test** と **RHEL-WEB-01-test** に変更されます。

10. [**仮想マシン**] ページで、**RHEL-WEB-01-test** VM を選択します。

![](./media/image17.png)

11. [**RHEL-WEB-01-test**] ページの [**設定**] で [**ネットワーク**] を選択します。

12. [**Networking**] ブレードで、ネットワーク インターフェイス **nic-RHEL-WEB-01-00-test** を選択します。

![](./media/image18.png)

13. [**nic-RHEL-WEB-01-00-test**] ページの [**Settings**] で [**IP configurations**] を選択します。

14. [**nic-RHEL-WEB-01-00-test-ipConfig**] を選択して、IP 構成を編集します。

![](./media/image19.png)

15. [**Edit IP configuration**] ブレードで、[**Associate public IP address**] のボックスをオンにし、[**Public IP address**] で [**ip43240741**] を選択します。

16. [**Save**] を選択して、関連付けが完了するまで待ちます。

17. 新しい Edge タブを開き、パブリック IP に割り当てた **DNS 名** に移動します:

```rhel-web-XXXXXX.westus2.cloudapp.azure.com```

18. RHEL-WEB-01-test でホストされている Drupal Web サイトが読み込まれることを確認します。

19. Web サイトが開かない場合は、仮想マシンの **ネットワーク設定** から **ネットワーク セキュリティ グループ** を作成し、下の画像に示すように **ポート 80** を有効にします。

![](./media/image26.png)

![](./media/image27.png)

**テスト移行のクリーンアップ**

19. [**移行と最新化 | レプリケーション**] ページに戻り、[**RHEL-DB-01**] を選択します。

20. [**テスト移行のクリーンアップ**] アクションを選択します。

![](./media/image20.png)

21. [**Notes**] フィールドを空白のままにして、[**Testing is complete. Delete test virtual machine**] のチェックボックスをオンにし、[**Cleanup Test**] を選択します。

22. [**Migration and modernization | Replications**] ページに戻り、[**RHEL-WEB-01**] を選択します。

23. [**Clean up test migration**] アクションを選択し、[**Testing is complete. Delete test virtual machine**] を指定します。

24. [**Migration and modernization | Replications**] ページに戻ります。

25. [**Replication status**] が [**Protected**] になるまで待ってから続行します。

> この更新を確認するには、1 ～ 2 分後に [**Refresh**] を選択する必要がある場合があります。

## タスク 5: 移行を実行する

1. **RHEL-DB-01** を選択し、**移行** アクションをトリガーします。

![](./media/image21.png)

2. **移行** ページで、**データ損失を最小限に抑えるために移行前にマシンをシャットダウンしますか?** オプションが **はい** に設定されていることを確認し、**移行** を選択します。

3. **移行と最新化 | レプリケーション** ページに戻り、**RHEL-WEB-01** を選択します。

4. **移行** を選択し、**移行** ページで再度 **はい** を指定して移行を開始します。

5. **移行と最新化 | レプリケーション** ページに戻り、**更新** を選択して移行のステータスを監視します。

![](./media/image28.png)

6. 次の演習のために Edge を開いたままにしておきます。移行処理は続行されます。

# 演習 2: 移行後のタスク

## タスク 1: 移行後のタスクを完了する

この演習では、先ほど作成したパブリック IP を、新しく移行した RHEL-WEB-01 VM に割り当てます。

1. [**移行と最新化 | レプリケーション**] ページで、両方の仮想マシンの [**状態**] 列に [**計画されたフェールオーバーが終了しました**] と表示されていることを確認します。

> この更新を表示するには、[**更新**] を選択する必要がある場合があります。

2. Azure ポータルの [**検索**] ボックスに「仮想マシン」と入力し、[**仮想マシン**] を選択します。

3. [**仮想マシン**] ページで、[**RHEL-WEB-01**] VM を選択します。

4. [**RHEL-WEB-01**] ページの [**設定**] で [**ネットワーク**] を選択します。

5. [**Networking**] ブレードで、ネットワーク インターフェイス **nic-RHEL-WEB-01-00** を選択します。

![](./media/image22.png)

6. [**nic-RHEL-WEB-01-00**] ページの [**Settings**] で [**IP configurations**] を選択します。

7. [**nic-RHEL-WEB-01-00-ipConfig**] を選択して、IP 構成を編集します。

![](./media/image23.png)

8. [**Edit IP configuration**] ブレードで、[**Associate public IP address**] のボックスをオンにし、[**Public IP address**] で [**ip43240741**] を選択します。

9. [**Save**] を選択して、関連付けが完了するまで待ちます。

10. 新しい Edge タブを開き、パブリック IP に割り当てた **DNS 名** に移動します: ```rhel-web-XXXXXX.westus2.cloudapp.azure.com```

11. Web サイトが開かない場合は、仮想マシンの **ネットワーク設定** から **ネットワーク セキュリティ グループ** を作成し、**ポート 80** を有効にします

12. RHEL-WEB-01 でホストされている Drupal Web サイトが読み込まれることを確認します。

13. **Hyper-V マネージャー** を開き、両方の VM が **オフ** になっていることを確認します。これらのマシンは正常に移行されています。

![](./media/image24.png)
